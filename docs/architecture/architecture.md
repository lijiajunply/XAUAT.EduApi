# 项目架构设计文档

## 版本信息

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|----------|------|
| 1.0 | 2024-12-02 | 初始创建 | 开发者团队 |

## 文档概述

本文档描述了西安建筑科技大学教务系统API（XAUAT EduApi）的整体架构设计，包括系统架构图、模块划分、核心组件交互流程及技术选型说明。本文档旨在帮助开发人员理解系统结构，便于后续的开发、维护和扩展。

## 目录

- [1. 系统整体架构](#1-系统整体架构)
  - [1.1 架构设计原则](#11-架构设计原则)
  - [1.2 系统架构图](#12-系统架构图)
  - [1.3 架构分层](#13-架构分层)
- [2. 模块划分](#2-模块划分)
  - [2.1 API控制器层](#21-api控制器层)
  - [2.2 业务逻辑层](#22-业务逻辑层)
  - [2.3 数据访问层](#23-数据访问层)
  - [2.4 服务发现层](#24-服务发现层)
  - [2.5 插件系统](#25-插件系统)
  - [2.6 监控与日志层](#26-监控与日志层)
- [3. 核心组件交互流程](#3-核心组件交互流程)
  - [3.1 用户登录流程](#31-用户登录流程)
  - [3.2 数据请求流程](#32-数据请求流程)
  - [3.3 插件加载流程](#33-插件加载流程)
- [4. 技术选型说明](#4-技术选型说明)
  - [4.1 基础框架](#41-基础框架)
  - [4.2 数据库](#42-数据库)
  - [4.3 缓存](#43-缓存)
  - [4.4 API文档](#44-api文档)
  - [4.5 日志与监控](#45-日志与监控)
  - [4.6 其他依赖](#46-其他依赖)
- [5. 系统扩展性设计](#5-系统扩展性设计)
  - [5.1 模块化设计](#51-模块化设计)
  - [5.2 插件机制](#52-插件机制)
  - [5.3 服务注册与发现](#53-服务注册与发现)
- [6. 部署架构](#6-部署架构)
  - [6.1 开发环境](#61-开发环境)
  - [6.2 测试环境](#62-测试环境)
  - [6.3 生产环境](#63-生产环境)

## 1. 系统整体架构

### 1.1 架构设计原则

本系统的架构设计遵循以下原则：

- **模块化**：系统采用模块化设计，各模块之间低耦合、高内聚，便于独立开发、测试和维护。
- **可扩展性**：通过插件机制和服务注册发现，支持系统的动态扩展和功能增强。
- **高性能**：使用缓存机制减少数据库访问，优化API响应速度。
- **可靠性**：实现了错误处理和重试机制，提高系统的容错能力。
- **安全性**：采用身份认证和授权机制，保护系统和数据安全。
- **可监控性**：集成了日志和监控功能，便于系统运行状态的监控和故障排查。

### 1.2 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                 │
├─────────────────┬─────────────────┬─────────────────────────────┤
│  Web应用        │  移动应用       │  其他第三方系统             │
└─────────────────┴─────────────────┴─────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         API网关层                               │
├─────────────────────────────────────────────────────────────────┤
│  请求路由、负载均衡、认证授权、限流熔断                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         服务层                                  │
├─────────────────┬─────────────────┬─────────────────────────────┤
│  XAUAT.EduApi   │  其他微服务     │  服务注册中心               │
│  (主服务)       │                │  (InMemoryServiceRegistry)  │
└─────────────────┴─────────────────┴─────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据层                                  │
├─────────────────┬─────────────────┬─────────────────────────────┤
│  PostgreSQL     │  SQLite         │  Redis缓存                   │
│  (生产环境)     │  (开发环境)     │                            │
└─────────────────┴─────────────────┴─────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         外部系统层                              │
├─────────────────┬─────────────────┬─────────────────────────────┤
│  教务处系统     │  校园卡系统     │  其他外部系统               │
└─────────────────┴─────────────────┴─────────────────────────────┘
```

### 1.3 架构分层

系统采用经典的三层架构设计，并在此基础上进行了扩展，主要分为以下几层：

1. **API控制器层**：负责处理HTTP请求，路由到相应的业务逻辑处理方法。
2. **业务逻辑层**：实现核心业务逻辑，处理数据的转换和处理。
3. **数据访问层**：负责与数据库和外部系统交互，获取和存储数据。
4. **服务发现层**：实现服务的注册和发现，支持系统的动态扩展。
5. **插件系统**：支持通过插件机制扩展系统功能，实现功能的热插拔。
6. **监控与日志层**：负责系统的监控和日志记录，便于系统运行状态的监控和故障排查。

## 2. 模块划分

### 2.1 API控制器层

API控制器层是系统对外的接口，负责处理HTTP请求，调用相应的业务逻辑，并返回响应结果。该层包含以下控制器：

- **LoginController**：处理用户登录请求，获取教务处系统的认证Cookie。
- **CourseController**：处理课程信息相关请求，获取学生课程表。
- **ScoreController**：处理成绩查询请求，获取学生的考试成绩。
- **ExamController**：处理考试安排请求，获取学生的考试时间安排。
- **ProgramController**：处理培养方案请求，获取专业培养计划。
- **InfoController**：处理学业进度请求，获取学生的学业完成情况。
- **PaymentController**：处理校园卡相关请求，获取消费记录。
- **BusController**：处理校车时刻表请求，获取校车运行时间。
- **AppController**：处理应用更新请求，获取移动端应用的最新版本。

### 2.2 业务逻辑层

业务逻辑层实现系统的核心业务逻辑，处理数据的转换和处理。该层包含以下服务：

- **ILoginService**：处理用户登录逻辑，与教务处系统进行交互。
- **ICourseService**：处理课程信息逻辑，获取和处理课程数据。
- **IScoreService**：处理成绩查询逻辑，获取和处理成绩数据。
- **IExamService**：处理考试安排逻辑，获取和处理考试数据。
- **IProgramService**：处理培养方案逻辑，获取和处理培养计划数据。
- **IInfoService**：处理学业进度逻辑，获取和处理学业完成情况数据。
- **IPaymentService**：处理校园卡逻辑，获取和处理消费记录数据。
- **IRedisService**：处理Redis缓存逻辑，提供缓存的读写操作。
- **IMonitoringService**：处理系统监控逻辑，收集和上报监控数据。

### 2.3 数据访问层

数据访问层负责与数据库和外部系统交互，获取和存储数据。该层包含以下组件：

- **EduContext**：使用Entity Framework Core实现与数据库的交互。
- **IScoreRepository**：处理成绩数据的访问，提供成绩数据的读写操作。
- **HttpClientFactory**：创建和管理HTTP客户端，用于与外部系统进行交互。
- **Redis服务**：提供缓存的存储和访问功能，提高系统性能。

### 2.4 服务发现层

服务发现层实现服务的注册和发现，支持系统的动态扩展。该层包含以下组件：

- **IServiceRegistry**：服务注册接口，定义了服务注册和发现的方法。
- **InMemoryServiceRegistry**：内存中的服务注册实现，用于开发和测试环境。
- **ServiceInstance**：服务实例类，包含服务的名称、实例ID、地址等信息。

### 2.5 插件系统

插件系统支持通过插件机制扩展系统功能，实现功能的热插拔。该层包含以下组件：

- **PluginManager**：插件管理器，负责插件的加载、初始化和卸载。
- **PluginContext**：插件上下文，提供插件访问系统资源的接口。
- **IPlugin**：插件接口，定义了插件的基本方法。

### 2.6 监控与日志层

监控与日志层负责系统的监控和日志记录，便于系统运行状态的监控和故障排查。该层包含以下组件：

- **Serilog**：日志框架，用于记录系统的运行日志。
- **Prometheus**：监控系统，用于收集和展示系统的监控指标。
- **MetricsMiddleware**：监控中间件，用于收集HTTP请求的监控指标。
- **ErrorHandlingMiddleware**：错误处理中间件，用于处理系统的异常情况。

## 3. 核心组件交互流程

### 3.1 用户登录流程

```
客户端 → API网关 → LoginController → ILoginService → 教务处系统 → ILoginService → LoginController → API网关 → 客户端
```

1. 客户端发送登录请求到API网关。
2. API网关将请求路由到LoginController。
3. LoginController调用ILoginService的LoginAsync方法。
4. ILoginService与教务处系统进行交互，获取认证Cookie。
5. ILoginService将登录结果返回给LoginController。
6. LoginController将登录结果返回给API网关。
7. API网关将登录结果返回给客户端。

### 3.2 数据请求流程

```
客户端 → API网关 → 相应的Controller → 相应的Service → 外部系统/数据库/缓存 → 相应的Service → 相应的Controller → API网关 → 客户端
```

1. 客户端发送数据请求到API网关。
2. API网关将请求路由到相应的Controller。
3. Controller调用相应的Service方法。
4. Service根据请求类型，从外部系统、数据库或缓存中获取数据。
5. Service将处理后的数据返回给Controller。
6. Controller将数据返回给API网关。
7. API网关将数据返回给客户端。

### 3.3 插件加载流程

```
应用启动 → PluginManager.Initialize() → PluginManager.LoadPlugins() → 遍历插件目录 → 加载插件程序集 → 初始化插件实例 → 调用插件的Initialize()方法 → 插件加载完成
```

1. 应用启动时，初始化PluginManager。
2. 调用PluginManager的LoadPlugins方法。
3. PluginManager遍历插件目录，查找插件程序集。
4. 加载插件程序集，创建插件实例。
5. 调用插件的Initialize方法，初始化插件。
6. 插件加载完成，系统继续启动。

## 4. 技术选型说明

### 4.1 基础框架

| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|----------|
| .NET | 10.0 | 核心框架 | 高性能、跨平台、成熟稳定，具有良好的生态系统。 |
| ASP.NET Core | 10.0 | Web API框架 | 轻量级、高性能、支持RESTful API开发，具有良好的扩展性。 |
| Entity Framework Core | 10.0 | ORM框架 | 简化数据库操作，支持多种数据库，具有良好的性能和扩展性。 |

### 4.2 数据库

| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|----------|
| PostgreSQL | 16.0 | 生产环境数据库 | 开源、高性能、支持复杂查询，适合处理大量结构化数据。 |
| SQLite | 3.45.0 | 开发环境数据库 | 轻量级、无需安装、适合开发和测试环境使用。 |

### 4.3 缓存

| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|----------|
| Redis | 7.2 | 分布式缓存 | 高性能、支持多种数据结构，适合缓存热点数据，提高系统性能。 |

### 4.4 API文档

| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|----------|
| Swagger/OpenAPI | 3.0 | API文档规范 | 行业标准，支持自动生成API文档，便于API的使用和测试。 |
| Scalar | 2.11.0 | API文档工具 | 现代化的API文档界面，支持交互式API测试，提高开发效率。 |

### 4.5 日志与监控

| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|----------|
| Serilog | 10.0 | 日志框架 | 高性能、结构化日志，支持多种输出目标，便于日志的收集和分析。 |
| Prometheus | 2.47 | 监控系统 | 开源、高性能、支持多维度监控指标，适合微服务架构的监控。 |
| Prometheus.Client.AspNetCore | 6.0.0 | .NET Prometheus客户端 | 与ASP.NET Core集成良好，便于收集和上报监控指标。 |

### 4.6 其他依赖

| 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|----------|
| Newtonsoft.Json | 13.0.4 | JSON处理 | 成熟稳定，功能丰富，支持复杂的JSON处理。 |
| Flurl.Http | 4.0.2 | HTTP客户端库 | 简化HTTP请求的发送和处理，提高开发效率。 |
| HtmlAgilityPack | 1.12.4 | HTML解析 | 用于解析教务处系统的HTML页面，提取结构化数据。 |
| StackExchange.Redis | 2.10.1 | Redis客户端 | 高性能、线程安全的Redis客户端，支持多种Redis操作。 |
| Microsoft.Extensions.Http.Polly | 10.0.0 | 弹性和 transient 故障处理 | 提供重试、熔断等机制，提高系统的容错能力。 |

## 5. 系统扩展性设计

### 5.1 模块化设计

系统采用模块化设计，各模块之间低耦合、高内聚，便于独立开发、测试和维护。每个模块都有明确的职责和接口，模块之间通过接口进行通信，减少了模块之间的依赖关系。

### 5.2 插件机制

系统实现了插件机制，支持通过插件扩展系统功能。插件可以动态加载和卸载，无需修改主程序代码。插件可以访问系统提供的资源和服务，实现功能的扩展和定制。

### 5.3 服务注册与发现

系统实现了服务注册与发现机制，支持服务的动态扩展和负载均衡。服务实例可以自动注册到服务注册中心，客户端可以通过服务注册中心发现可用的服务实例，实现服务的动态调用。

## 6. 部署架构

### 6.1 开发环境

- **操作系统**：Windows/macOS/Linux
- **数据库**：SQLite（内嵌数据库，无需单独安装）
- **缓存**：可选Redis（用于开发环境测试）
- **部署方式**：本地开发环境，使用`dotnet run`命令启动

### 6.2 测试环境

- **操作系统**：Linux
- **数据库**：PostgreSQL
- **缓存**：Redis
- **部署方式**：Docker容器化部署，使用Docker Compose管理服务

### 6.3 生产环境

- **操作系统**：Linux
- **数据库**：PostgreSQL（集群部署）
- **缓存**：Redis（集群部署）
- **部署方式**：Docker容器化部署，使用Kubernetes管理服务
- **负载均衡**：使用Nginx或API网关进行负载均衡
- **监控**：Prometheus + Grafana监控系统
- **日志**：ELK Stack（Elasticsearch + Logstash + Kibana）

## 更新日志

| 日期 | 版本 | 更新内容 | 作者 |
|------|------|----------|------|
| 2024-12-02 | 1.0 | 初始创建 | 开发者团队 |

## 相关资源

- [项目GitHub仓库](https://github.com/your-repo/XAUAT.EduAp)
- [API文档](/scalar/v1)（部署后可访问）
- [部署指南](../deployment/deployment.md)
- [开发指南](../development/development.md)
